# LED Calculator Widget для Bitrix24

Приложение для расчета стоимости светодиодной продукции, интегрированное с Bitrix24 CRM.

## Описание

Это виджет для Bitrix24, который добавляет кнопку LED калькулятора в карточку сделки (CRM_DEAL_DETAIL_ACTIVITY). При нажатии на кнопку открывается калькулятор стоимости LED продукции во встроенном фрейме.

## Возможности

- ✅ Интеграция с Bitrix24 CRM (карточка сделки)
- ✅ Поддержка iframe с правильными заголовками безопасности
- ✅ Передача контекста сделки в калькулятор
- ✅ Автоматическая установка placement в CRM
- ✅ Совместимость с Bitrix24 SDK 1.5

## Структура проекта

```
led-calculator-widget/
├── public/                   # Публичные файлы приложения
│   ├── handler.php           # Основной обработчик приложения
│   └── install.php           # Основной обработчик приложения
├── logs/                     # Логи приложения
├── vendor/                   # Зависимости Composer
├── composer.json             # Конфигурация зависимостей
└── .env                      # Переменные окружения
```

## Установка

1. Скопируйте файлы проекта в директорию веб-сервера
2. Установите зависимости: `composer install`
3. Настройте веб-сервер на директорию `public/`
4. Создайте приложение в Bitrix24:
   - Тип: Локальное приложение
   - Обработчик: `https://your-domain.com/index.php`
   - Установка: `https://your-domain.com/install.php`
   - Права: `crm`, `user`, `placement`

## Технические детали

### Заголовки безопасности
- `Content-Security-Policy: frame-ancestors *;` - разрешает загрузку во фрейме
- Удален неправильный `X-Frame-Options: ALLOWALL`

### Iframe атрибуты
- `allow="scripts, forms"` - разрешает выполнение скриптов и отправку форм
- `sandbox="allow-scripts allow-forms allow-same-origin"` - безопасная изоляция

### Совместимость с Bitrix24 SDK
- Использует Bitrix24 SDK версии 1.5
- Обходит устаревшие методы API (`getPlacementOptions`, `getUserService`)
- Получает данные напрямую из `$_REQUEST`

## Режимы работы

### Тестовый режим (без параметров)
Если приложение вызывается без параметров Bitrix24, показывается тестовый iframe с калькулятором.

### Placement режим (с параметрами Bitrix24)
При вызове из карточки сделки передаются параметры:
- `dealId` - ID сделки
- `domain` - домен Bitrix24
- `authId` - токен авторизации
- `memberId` - ID участника

## Логи

Все действия приложения логируются в файлы директории `logs/`:
- Процесс установки
- Работа с Bitrix24 API
- Ошибки выполнения

## Требования

- PHP 8.1+
- Composer
- Поддержка cURL
- Веб-сервер (Apache/Nginx)

## Разработка

Проект использует стандартную структуру PHP приложения с:
- PSR-4 автозагрузкой через Composer
- Bitrix24 PHP SDK для работы с API
- Монологированием для отладки

## Лицензия

Проприетарное ПО для Dimpin App Store.